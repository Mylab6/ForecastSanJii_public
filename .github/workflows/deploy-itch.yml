name: Deploy to Itch.io
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:latest   # <- Docker Hub, not ghcr
    env:
      EXPORT_PRESET: "Web"
      ITCH_TARGET: "${{ secrets.ITCH_GAME_URL }}:html5"
      BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - run: |
          godot --version || true
          butler -V || true
      - run: |
          set -euo pipefail
          mkdir -p build
          godot --headless --path . --export-release "$EXPORT_PRESET" "build/index.html"
      - run: |
          set -euo pipefail
          cd build && zip -qr forecast_sanjii_web.zip .
      - uses: actions/upload-artifact@v4
        with:
          name: html5-build
          path: build/forecast_sanjii_web.zip
          if-no-files-found: error
      - run: |
          set -euo pipefail
          VERSION="${GITHUB_RUN_NUMBER}.${GITHUB_SHA::7}"
          butler push build/forecast_sanjii_web.zip "$ITCH_TARGET" --userversion "$VERSION"
